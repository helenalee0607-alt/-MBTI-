"""
MBTI Multi-Agent Interview Simulator (DeepSeek Version, Company Domain + MCQ Edition)

æ”¹åŠ¨è¯´æ˜ï¼š
1. æ–°å¢ â€œå…¬å¸é¢†åŸŸæ–¹å‘â€ è¾“å…¥ï¼š
   - åœ¨è¯¢é—®åº”è˜èŒä¸šåï¼Œè¿½åŠ é—®é¢˜ï¼šä½ æƒ³é¢è¯•çš„æ˜¯å“ªä¸€ç±»å…¬å¸çš„é¢†åŸŸæ–¹å‘ï¼Ÿ
   - ä¾‹å¦‚ï¼šäº’è”ç½‘é‡‘èã€æ¶ˆè´¹ç”µå•†ã€æ¸¸æˆã€æ™ºèƒ½åˆ¶é€ ã€æ•™è‚²ç§‘æŠ€ç­‰ã€‚

2. å…¬å¸èƒŒæ™¯ä¸è¡Œä¸šçŸ¥è¯†ï¼š
   - åŸºäºã€ŒèŒä¸š + é¢†åŸŸæ–¹å‘ã€ç”Ÿæˆä¸€æ®µè¯¦ç»†çš„å…¬å¸èƒŒæ™¯ + è¡Œä¸šé€šè¯†ä»‹ç»ã€‚
   - æ‰€æœ‰åç»­æé—®ï¼ˆé€‰æ‹©é¢˜/å¼€æ”¾é¢˜/æƒ…å¢ƒé¢˜/è¯„ä»·ï¼‰éƒ½åŸºäºè¯¥èƒŒæ™¯ã€‚

3. é€‰æ‹©é¢˜æ˜¾ç¤ºä¼˜åŒ–ï¼š
   - æ¯ä½é¢è¯•å®˜çš„é€‰æ‹©é¢˜å‰ä¼šæ˜¾ç¤ºï¼šã€ENTJ é¢è¯•å®˜ï¼ˆENTJï¼‰ã€‘çš„é€‰æ‹©é¢˜ï¼š
   - å¼ºåŒ– promptï¼Œè¦æ±‚è¾“å‡ºå®Œæ•´çš„ A/B/C/D å››ä¸ªé€‰é¡¹ã€‚
   - ç®€å•æ£€æŸ¥ï¼šè‹¥æ²¡æ£€æµ‹åˆ° A./B./C./D.ï¼Œä¼šç»™å‡ºæç¤ºï¼Œä½†ä¸æŠ¥é”™ã€‚

4. å»æ‰â€œç¡®è®¤å›ç­”â€äº¤äº’ï¼š
   - æ‰€æœ‰å›ç­”ç›´æ¥ä½¿ç”¨ input()ï¼Œä¸å†åå¤ç¡®è®¤ã€‚
"""

import os
from dataclasses import dataclass
from typing import List
from openai import OpenAI

# ========== 0. DeepSeek é…ç½®ï¼ˆå®‰å…¨ç‰ˆï¼‰ ==========

# è¯·åœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡æˆ– .env ä¸­è®¾ç½®ï¼š
#   DEEPSEEK_API_KEY=sk-xxxxxxxx
#
# Windowsï¼ˆPowerShellï¼‰è®¾ç½®ç¤ºä¾‹ï¼š
#   setx DEEPSEEK_API_KEY "sk-xxxxxxxx"

DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")

if not DEEPSEEK_API_KEY:
    raise RuntimeError(
        "æœªæ£€æµ‹åˆ° DEEPSEEK_API_KEY ç¯å¢ƒå˜é‡ã€‚\n"
        "è¯·åœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡æˆ–é¡¹ç›® .env æ–‡ä»¶ä¸­è®¾ç½®ï¼Œä¾‹å¦‚ï¼š\n"
        "  DEEPSEEK_API_KEY=sk-xxxxx"
    )

client = OpenAI(
    api_key=DEEPSEEK_API_KEY,
    base_url="https://api.deepseek.com",
)

MODEL = "deepseek-chat"


# ========== 1. æ•°æ®ç»“æ„ ==========

@dataclass
class QARecord:
    stage: str
    interviewer: str
    question: str
    answer: str


# ========== 2. é¢è¯•å®˜æé—®ä¸»é¢˜ ==========

TOPIC_SCOPE = {
    "ENTJ": "ç›®æ ‡æ¨è¿›ã€æ‰§è¡Œæ•ˆç‡ã€å›°éš¾å†³ç­–ã€èµ„æºåˆ†é…ã€å†²çªç®¡ç†ã€é©±åŠ¨ç»“æœ",
    "INTP": "å‡è®¾æ„å»ºã€å› æœæ¨ç†ã€å˜é‡æ§åˆ¶ã€æ¨¡å‹æ¡†æ¶ã€é€»è¾‘ä¸€è‡´æ€§ã€å®éªŒè®¾è®¡",
    "ENFP": "åŠ¨æœºã€ä»·å€¼è§‚ã€æ„¿æ™¯ã€å›¢é˜Ÿæ–‡åŒ–ã€åˆ›é€ æ€§è¡¨è¾¾ã€æ•…äº‹åŒ–æ²Ÿé€š",
    "ISTJ": "æµç¨‹è§„èŒƒã€ç»†èŠ‚å‡†ç¡®æ€§ã€ç¨³å®šæ€§ã€é£é™©æ§åˆ¶ã€æ•°æ®éªŒè¯ã€å¯æ‰§è¡Œæ­¥éª¤",
    "INFJ": "äººé™…å…³ç³»ã€æ²Ÿé€šç­–ç•¥ã€å›¢é˜Ÿæ°›å›´ã€å†²çªæ´å¯Ÿã€æƒ…ç»ªç†è§£ã€ç»„ç»‡åä½œ",
}


# ========== 3. åŸºç¡€ Agent ==========

class BaseAgent:
    def __init__(self, name: str, mbti: str, persona: str):
        self.name = name
        self.mbti = mbti
        self.persona = persona

    def chat(self, msg: str, temperature=0.6) -> str:
        resp = client.chat.completions.create(
            model=MODEL,
            messages=[
                {"role": "system", "content": self.persona},
                {"role": "user", "content": msg},
            ],
            temperature=temperature,
        )
        return resp.choices[0].message.content.strip()


# ========== 4. ç”Ÿæˆè™šæ„å…¬å¸èƒŒæ™¯ + è¡Œä¸šçŸ¥è¯† ==========

def generate_company_profile(job: str, domain: str) -> str:
    """
    ç”Ÿæˆä¸€æ®µç»Ÿä¸€çš„å…¬å¸èƒŒæ™¯ & è¡Œä¸šçŸ¥è¯†ä»‹ç»ï¼š
    - è¡Œä¸šä¸ä¸šåŠ¡æ¨¡å¼
    - å…¸å‹äº§å“/æœåŠ¡
    - å…¬å¸è§„æ¨¡ä¸é˜¶æ®µ
    - å›¢é˜Ÿæ–‡åŒ–ä¸è°ƒæ€§
    - å’Œ {job} åœ¨è¯¥é¢†åŸŸçš„ä¸€äº›å¸¸è§å·¥ä½œé‡ç‚¹
    """
    prompt = f"""
ä½ æ˜¯ä¸€åèµ„æ·± HR ï¼‹ è¡Œä¸šç ”ç©¶å‘˜ï¼Œç°åœ¨è¦ä¸ºåº”è˜ã€Œ{domain}ã€é¢†åŸŸçš„ã€Œ{job}ã€å²—ä½çš„å€™é€‰äººè®¾è®¡é¢è¯•ã€‚

è¯·å¸®æˆ‘è®¾å®šä¸€å®¶å…¬å¸ï¼ˆè™šæ„å³å¯ï¼‰ï¼Œå¹¶ç”¨ 6-10 è¡Œæ¸…æ™°ä»‹ç»è¿™å®¶å…¬å¸çš„èƒŒæ™¯å’Œè¯¥é¢†åŸŸçš„åŸºæœ¬çŸ¥è¯†ï¼Œå¿…é¡»åŒ…å«ï¼š

1ï¼‰é¢†åŸŸä¸è¡Œä¸šæ¦‚å†µï¼š
   - ç®€å•è¯´æ˜ã€Œ{domain}ã€å±äºä»€ä¹ˆè¡Œä¸šï¼Œå®ƒå…¸å‹çš„å•†ä¸šæ¨¡å¼/ç›ˆåˆ©æ–¹å¼æœ‰å“ªäº›ï¼Ÿ
   - ä¸¾ 1-2 ä¸ªè¿™ä¸ªé¢†åŸŸå¸¸è§çš„ä¸šåŠ¡åœºæ™¯æˆ–äº§å“å½¢æ€ã€‚

2ï¼‰å…¬å¸æœ¬èº«ï¼ˆè™šæ„å…¬å¸ï¼‰çš„ä¿¡æ¯ï¼š
   - è¡Œä¸šç»†åˆ†æ–¹å‘ & ä¸»è¦äº§å“/æœåŠ¡
   - å…¬å¸è§„æ¨¡ä¸å‘å±•é˜¶æ®µï¼ˆä¾‹å¦‚ï¼šæˆç«‹ 5 å¹´ã€200 äººã€B è½®èèµ„ã€æ­£åœ¨å¿«é€Ÿæ‰©å¼ ç­‰ï¼‰
   - ä¸»è¦å®¢æˆ·/ç”¨æˆ·ç¾¤ä½“ï¼ˆä¾‹å¦‚ï¼šC ç«¯æ•£æˆ·æŠ•èµ„è€…ã€ä¼ä¸šçº§å®¢æˆ·ã€ä¸­å°å•†å®¶ç­‰ï¼‰

3ï¼‰å›¢é˜Ÿæ–‡åŒ–ä¸å…¬å¸è°ƒæ€§ï¼š
   - ç”¨ 2-3 å¥è¯æè¿°å…¬å¸çš„æ–‡åŒ–å’Œå·¥ä½œæ°›å›´ï¼ˆä¾‹å¦‚ï¼šæ•°æ®é©±åŠ¨ã€ç»“æœå¯¼å‘ã€ç¨³å®šä¿å®ˆã€åˆ›æ„å¯¼å‘ç­‰ï¼‰
   - ç”¨ä¸€å¥è¯æ¦‚æ‹¬â€œå…¬å¸è°ƒæ€§â€ï¼Œå¯ä»¥æ˜¯â€œç†æ€§åŠ¡å®â€â€œåˆ›æ„é©±åŠ¨â€â€œç¨³å¥ä¿å®ˆâ€â€œç‹¼æ€§å†²åˆºâ€ç­‰ã€‚

4ï¼‰ã€Œ{job}ã€åœ¨è¯¥é¢†åŸŸä¸­çš„è§’è‰²ï¼š
   - ç®€è¦è¯´æ˜åœ¨è¿™å®¶å…¬å¸é‡Œï¼Œã€Œ{job}ã€é€šå¸¸ä¼šè´Ÿè´£å“ªäº›æ ¸å¿ƒå·¥ä½œï¼ˆä¸¾ 2-3 ä¸ªç‚¹å³å¯ï¼‰ï¼Œ
     å°¤å…¶æ˜¯å’Œæ•°æ®/ä¸šåŠ¡/åä½œç›¸å…³çš„å†…å®¹ã€‚

ã€è¾“å‡ºè¦æ±‚ã€‘ï¼š
- ç”¨ä¸­æ–‡ã€‚
- ç›´æ¥ç”¨è‡ªç„¶æ®µæè¿°ï¼Œä¸è¦ä½¿ç”¨ â‘ â‘¡â‘¢ æˆ–æ¡ç›®ç¬¦å·ã€‚
- ä¸è¦å†™ä»»ä½•â€œä»¥ä¸‹æ˜¯â€â€œæ€»ç»“æ¥è¯´â€è¿™ç±»å¤šä½™è¯ï¼Œç›´æ¥è¾“å‡ºå†…å®¹ã€‚
- ä¸è¦ä½¿ç”¨çœŸå®å…¬å¸åå­—ï¼Œç»Ÿä¸€ç”¨â€œè¿™å®¶å…¬å¸â€æ¥æŒ‡ä»£ã€‚
"""
    resp = client.chat.completions.create(
        model=MODEL,
        messages=[
            {
                "role": "system",
                "content": "ä½ æ˜¯èµ„æ·± HR å’Œè¡Œä¸šç ”ç©¶å‘˜ï¼Œæ“…é•¿ç”¨ç®€æ´æ¸…æ¥šçš„ä¸­æ–‡æè¿°è¡Œä¸šä¸å…¬å¸èƒŒæ™¯ã€‚",
            },
            {"role": "user", "content": prompt},
        ],
        temperature=0.6,
    )
    return resp.choices[0].message.content.strip()


# ========== 5. é¢è¯•å®˜ Agentï¼ˆåŠ å…¥å…¬å¸èƒŒæ™¯ + é¢†åŸŸï¼‰ ==========

class Interviewer(BaseAgent):
    def intro(self):
        # è‡ªæˆ‘é£æ ¼ä»‹ç»ï¼Œä¿æŒä¸€å¥è¯
        return self.chat(
            "è¯·ç”¨ä¸€å¥ä¸­æ–‡ä»‹ç»ä½ çš„é¢è¯•é£æ ¼ï¼Œä¸è¶…è¿‡20ä¸ªå­—ï¼Œè¦å…·ä½“ã€æœ‰ç”»é¢æ„Ÿï¼Œé¿å…ç©ºè¯ã€‚"
        )

    def ask_mc_question(self, job: str, domain: str, company_profile: str) -> str:
        """
        é€‰æ‹©é¢˜çƒ­èº«ï¼šåŸºäºé¢†åŸŸ + å…¬å¸èƒŒæ™¯ + å²—ä½ï¼Œå‡ºä¸€é¢˜ 4 é€‰ 1ã€‚
        """
        prompt = f"""
ä½ æ˜¯ä¸€å {self.mbti} é¢è¯•å®˜ï¼Œæ­£åœ¨ä¸ºåº”è˜ã€Œ{domain}ã€é¢†åŸŸçš„ã€Œ{job}ã€å²—ä½çš„å€™é€‰äººåšé¢è¯•ã€‚

ä¸‹é¢æ˜¯è¿™å®¶å…¬å¸çš„ç»Ÿä¸€èƒŒæ™¯æè¿°ï¼ˆä¾›ä½ å‡ºé¢˜æ—¶å‚è€ƒï¼‰ï¼š
----------------
{company_profile}
----------------

ä»»åŠ¡ï¼šè¯·åŸºäºã€è¿™å®¶å…¬å¸ + {domain} é¢†åŸŸ + {job} å²—ä½ã€‘å‡ºä¸€é¢˜â€œé€‰æ‹©é¢˜çƒ­èº«â€ï¼Œç”¨äºäº†è§£å€™é€‰äººåœ¨çœŸå®å·¥ä½œåœºæ™¯ä¸‹çš„ä¹ æƒ¯å’Œåå¥½ã€‚

ã€å‡ºé¢˜è¦æ±‚ã€‘ï¼š
1ï¼‰é¢˜å¹²å¿…é¡»åŒ…å«æ¸…æ™°çš„æƒ…å¢ƒï¼š
   - æŒ‡æ˜æ˜¯è¿™å®¶å…¬å¸çš„ä»€ä¹ˆä¸šåŠ¡/å›¢é˜Ÿã€å½“å‰é‡åˆ°ä»€ä¹ˆå…·ä½“æƒ…å†µ
   - ç¡®ä¿å€™é€‰äººåªçœ‹é¢˜å¹²ï¼Œå°±èƒ½ç†è§£å¤§æ¦‚å‘ç”Ÿäº†ä»€ä¹ˆ
2ï¼‰é€‰é¡¹ A/B/C/D å¿…é¡»æ˜¯å€™é€‰äººâ€œå¯èƒ½é‡‡å–çš„ä¸åŒè¡Œä¸ºæˆ–å€¾å‘â€ï¼Œ
   - æ¯ä¸ªé€‰é¡¹éƒ½åˆç†ã€æ²¡æœ‰å”¯ä¸€æ­£ç¡®ç­”æ¡ˆ
   - é€‰é¡¹ä¹‹é—´è¦æœ‰æ˜æ˜¾å·®å¼‚ï¼ˆä¾‹å¦‚ï¼šæ›´æ³¨é‡ç»“æœ / æ›´æ³¨é‡å…³ç³» / æ›´ä¿å®ˆ / æ›´æ¿€è¿›ï¼‰
3ï¼‰éš¾åº¦é€‚ä¸­ï¼Œè´´åˆã€Œ{job}ã€åœ¨ã€Œ{domain}ã€é¢†åŸŸä¸­çš„æ—¥å¸¸èŒè´£ã€‚

ã€è¾“å‡ºæ ¼å¼ï¼ˆåŠ¡å¿…ä¸¥æ ¼éµå®ˆï¼‰ã€‘ï¼š
ç¬¬ä¸€è¡Œï¼šé¢˜å¹²ï¼ˆä¸€å¥å®Œæ•´çš„è¯ï¼‰
ç¬¬äºŒè¡Œï¼šA. é€‰é¡¹å†…å®¹
ç¬¬ä¸‰è¡Œï¼šB. é€‰é¡¹å†…å®¹
ç¬¬å››è¡Œï¼šC. é€‰é¡¹å†…å®¹
ç¬¬äº”è¡Œï¼šD. é€‰é¡¹å†…å®¹

âš  å¼ºåˆ¶è¦æ±‚ï¼š
- å¿…é¡»åŒæ—¶åŒ…å« A.ã€B.ã€C.ã€D. å››ä¸ªé€‰é¡¹ï¼Œæ¯ä¸ªé€‰é¡¹å•ç‹¬ä¸€è¡Œã€‚
- ä¸è¦è¾“å‡ºç¬¬å…­è¡ŒåŠä¹‹åçš„å†…å®¹ã€‚
- ä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šæˆ–å‰åè¯´æ˜ï¼ŒåªæŒ‰ä¸Šè¿° 5 è¡Œè¾“å‡ºã€‚

ç°åœ¨è¯·ç›´æ¥æŒ‰ç…§æ ¼å¼è¾“å‡ºé¢˜å¹²å’Œå››ä¸ªé€‰é¡¹ã€‚
"""
        return self.chat(prompt)

    def ask_rapid(self, job: str, domain: str, company_profile: str) -> str:
        """
        å¼€æ”¾å¼å¿«é€Ÿæé—®ï¼šå¸¦æƒ…å¢ƒã€å’Œå…¬å¸ + é¢†åŸŸ + å²—ä½å¼ºç›¸å…³ã€‚
        """
        prompt = f"""
ä½ æ˜¯ä¸€å {self.mbti} é¢è¯•å®˜ã€‚
ä½ çš„æé—®ä¸»é¢˜èŒƒå›´ï¼š
{TOPIC_SCOPE[self.mbti]}

è¿™æ¬¡é¢è¯•çš„é¢†åŸŸæ–¹å‘æ˜¯ï¼šã€Œ{domain}ã€ã€‚
å…¬å¸çš„ç»Ÿä¸€èƒŒæ™¯å¦‚ä¸‹ï¼ˆè¯·åŠ¡å¿…åŸºäºæ­¤å‡ºé¢˜ï¼‰ï¼š
----------------
{company_profile}
----------------

ä»»åŠ¡ï¼šæå‡ºä¸€ä¸ªå…³äºã€Œ{job}ã€åœ¨ã€Œ{domain}ã€é¢†åŸŸä¸­å·¥ä½œçš„å¿«é€Ÿå¼€æ”¾å¼é—®é¢˜ã€‚

ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼š
1ï¼‰é—®é¢˜å¿…é¡»å¸¦å®Œæ•´æƒ…å¢ƒï¼š
   - æ˜ç¡®è¯´æ˜æ˜¯åœ¨â€œè¿™å®¶å…¬å¸â€çš„ä»€ä¹ˆä¸šåŠ¡/é¡¹ç›®/å›¢é˜Ÿä¸­
   - ç®€è¦ç»™å‡ºå½“å‰çš„çŠ¶æ€æˆ–å›°éš¾ï¼ˆå¦‚ï¼šå¢é•¿æ”¾ç¼“ã€æŒ‡æ ‡å‹åŠ›ã€è·¨éƒ¨é—¨æ‰¯çš®ã€ç›‘ç®¡å˜åŒ–ã€ç”¨æˆ·æŠ•è¯‰ç­‰ï¼‰
   - è®©å€™é€‰äººçŸ¥é“â€œå‘ç”Ÿäº†ä»€ä¹ˆâ€å’Œâ€œä½ é—®ä»–åœ¨è¿™ä¸ªæƒ…å¢ƒä¸‹ä¼šæ€ä¹ˆåšâ€
2ï¼‰é—®é¢˜å¿…é¡»åŒæ—¶ä½“ç°ï¼š
   - ä½ çš„ MBTI ä¸»é¢˜èŒƒå›´ï¼ˆ{TOPIC_SCOPE[self.mbti]}ï¼‰
   - å’Œã€Œ{job}ã€åœ¨ã€Œ{domain}ã€é¢†åŸŸçš„å®é™…å·¥ä½œç›¸å…³
3ï¼‰éš¾åº¦é€‚ä¸­ï¼š
   - æœ‰æ€è€ƒç©ºé—´ï¼Œä½†ä¸éœ€è¦å†™è®ºæ–‡çº§å›ç­”ã€‚
4ï¼‰å½¢å¼è¦æ±‚ï¼š
   - ç”¨ä¸­æ–‡ã€‚
   - ä¸€å¥è¯ï¼Œç›´æ¥è¾“å‡ºé—®é¢˜æœ¬èº«ï¼Œä¸è¦ä»»ä½•è¯´æ˜ã€‚

è¯·ç»™å‡ºè¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ã€‚
"""
        return self.chat(prompt)

    def ask_follow_up(
        self,
        prev_answer: str,
        job: str,
        domain: str,
        company_profile: str,
    ) -> str:
        """
        æ·±åº¦è¿½é—®ï¼šåŸºäºå€™é€‰äººçš„ä¸Šä¸€ä¸ªå›ç­” + è¡Œä¸šé¢†åŸŸ + å…¬å¸èƒŒæ™¯ã€‚
        """
        prompt = f"""
å€™é€‰äººåº”è˜ã€Œ{domain}ã€é¢†åŸŸçš„ã€Œ{job}ã€å²—ä½ï¼Œåœ¨ä¸Šä¸€é¢˜ä¸­çš„å›ç­”æ˜¯ï¼š
ã€å€™é€‰äººå›ç­”ã€‘{prev_answer}

è¿™æ¬¡é¢è¯•çš„é¢†åŸŸæ–¹å‘æ˜¯ï¼šã€Œ{domain}ã€ã€‚
å…¬å¸çš„ç»Ÿä¸€èƒŒæ™¯å¦‚ä¸‹ï¼ˆä½ è¦å‡å®šæ‰€æœ‰é—®é¢˜éƒ½å‘ç”Ÿåœ¨è¿™å®¶å…¬å¸ï¼‰ï¼š
----------------
{company_profile}
----------------

ä½ æ˜¯ {self.mbti} é¢è¯•å®˜ï¼Œä½ çš„æé—®ä¸»é¢˜èŒƒå›´æ˜¯ï¼š
{TOPIC_SCOPE[self.mbti]}

ä»»åŠ¡ï¼šåŸºäºå€™é€‰äººçš„è¿™æ®µå›ç­”ï¼Œæå‡ºä¸€ä¸ªâ€œæ·±å…¥è¿½é—®â€çš„é—®é¢˜ã€‚

ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼š
1ï¼‰è¿½é—®å¿…é¡»ä¸å€™é€‰äººçš„å›ç­”å†…å®¹ç›´æ¥ç›¸å…³ï¼Œå¯ä»¥ä»ä»¥ä¸‹è§’åº¦å»¶ä¼¸ï¼š
   - å†³ç­–ä¾æ® / å–èˆæ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ
   - å¿½ç•¥äº†å“ªäº›é£é™©æˆ–åˆ©ç›Šç›¸å…³æ–¹ï¼Ÿ
   - ä»–è¯´å¾—æ¯”è¾ƒç¬¼ç»Ÿçš„åœ°æ–¹ï¼Œè¦æ±‚ç»™å‡ºæ›´å…·ä½“çš„ä¾‹å­æˆ–æ ‡å‡†ã€‚
2ï¼‰é—®é¢˜å¿…é¡»å‘ç”Ÿåœ¨â€œè¿™å®¶å…¬å¸ + {domain} é¢†åŸŸ + {job} å²—ä½â€çš„çœŸå®å·¥ä½œåœºæ™¯é‡Œã€‚
3ï¼‰ç”¨ä¸­æ–‡ï¼Œä¸€å¥è¯ï¼Œç›´æ¥è¾“å‡ºé—®é¢˜æœ¬èº«ã€‚

è¯·ç»™å‡ºè¿™ä¸ªæ·±å…¥è¿½é—®çš„é—®é¢˜ã€‚
"""
        return self.chat(prompt)

    def ask_scenario(self, job: str, domain: str, company_profile: str) -> str:
        """
        æƒ…å¢ƒé¢˜ï¼šè¯¦ç»†è¯´æ˜å…¬å¸ + é¢†åŸŸ + å›¢é˜Ÿ + é—®é¢˜ï¼Œå†é—®å€™é€‰äººæ€ä¹ˆåŠã€‚
        """
        prompt = f"""
ä½ æ˜¯ {self.mbti} é¢è¯•å®˜ï¼Œæ­£åœ¨ä¸ºã€Œ{domain}ã€é¢†åŸŸçš„ã€Œ{job}ã€å²—ä½å‡ºä¸€é¢˜æƒ…å¢ƒé¢˜ã€‚

è¿™æ¬¡é¢è¯•çš„é¢†åŸŸæ–¹å‘æ˜¯ï¼šã€Œ{domain}ã€ã€‚
å…¬å¸çš„ç»Ÿä¸€èƒŒæ™¯å¦‚ä¸‹ï¼š
----------------
{company_profile}
----------------

ä»»åŠ¡ï¼šè®¾è®¡ä¸€ä¸ªå‘ç”Ÿåœ¨â€œè¿™å®¶å…¬å¸â€çš„æƒ…å¢ƒé¢˜ã€‚

ã€æƒ…å¢ƒè¦æ±‚ã€‘ï¼š
1ï¼‰é¢˜ç›®å¿…é¡»åŒ…å«ï¼š
   - è¿™å®¶å…¬å¸åœ¨ã€Œ{domain}ã€ä¸­çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼ˆå¯ä»ä¸Šé¢çš„èƒŒæ™¯åˆç†æç‚¼ï¼‰
   - å€™é€‰äººæ‰€åœ¨çš„å›¢é˜Ÿè§’è‰²ï¼ˆä¾‹å¦‚ï¼šæŸä¸ªä¸šåŠ¡çº¿/é¡¹ç›®ç»„çš„ {job}ï¼‰
   - æ­£åœ¨é¢ä¸´çš„ä¸€ä»¶å…·ä½“äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼šæ–°å“ä¸Šçº¿å»¶æœŸã€æ ¸å¿ƒæŒ‡æ ‡ä¸è¾¾æ ‡ã€è€æ¿ä¸´æ—¶æ”¹æ–¹å‘ã€ç”¨æˆ·å¼ºçƒˆåæ§½ç­‰ï¼‰
2ï¼‰é¢˜ç›®å¿…é¡»ç¬¦åˆä½ çš„æé—®ä¸»é¢˜èŒƒå›´ï¼š
   {TOPIC_SCOPE[self.mbti]}
3ï¼‰ç”¨ä¸€å¥è¯æŠŠæƒ…å¢ƒ + æé—®è¯´æ¸…æ¥šï¼ˆå¯ä»¥ç¨å¾®é•¿ä¸€ç‚¹ï¼‰ã€‚

ã€è¾“å‡ºè¦æ±‚ã€‘ï¼š
- ç”¨ä¸­æ–‡ã€‚
- ä¸€å¥è¯ï¼Œç›´æ¥è¾“å‡ºæƒ…å¢ƒé¢˜æœ¬èº«ï¼ˆä¸è¦è§£é‡Šï¼‰ã€‚

è¯·ç»™å‡ºè¿™é“æƒ…å¢ƒé¢˜ã€‚
"""
        return self.chat(prompt)

    def comment(
        self,
        question: str,
        answer: str,
        job: str,
        domain: str,
        company_profile: str,
    ) -> str:
        prompt = f"""
ä½ æ˜¯ {self.mbti} é¢è¯•å®˜ã€‚

é¢†åŸŸæ–¹å‘ï¼šã€Œ{domain}ã€ã€‚
å…¬å¸èƒŒæ™¯å¦‚ä¸‹ï¼š
----------------
{company_profile}
----------------

å²—ä½ï¼š{job}
æƒ…å¢ƒé¢˜ï¼š{question}
å€™é€‰äººå›ç­”ï¼š{answer}

ä½ çš„è¯„ä»·é€»è¾‘åŸºäºä½ çš„ä¸»é¢˜èŒƒå›´ï¼š
{TOPIC_SCOPE[self.mbti]}

ä»»åŠ¡ï¼šç»™å‡ºç®€çŸ­ã€å…·ä½“çš„ä¸“ä¸šç‚¹è¯„ï¼Œå¯ä»¥åŒ…å«ï¼š
- ä¸€ä¸ªæ˜æ˜¾çš„ä¼˜ç‚¹ï¼ˆä¾‹å¦‚ï¼šæ€è·¯æ¸…æ™°ã€è€ƒè™‘åˆ©ç›Šç›¸å…³æ–¹ã€æ‰§è¡Œè·¯å¾„æ¸…æ¥šç­‰ï¼‰
- ä¸€ä¸ªå¯ä»¥æ”¹è¿›çš„å°ç‚¹ï¼ˆä¾‹å¦‚ï¼šé£é™©æ„è¯†ä¸å¤Ÿã€ç¼ºå°‘é‡åŒ–æŒ‡æ ‡ã€å¿½ç•¥å›¢é˜Ÿæƒ…ç»ªç­‰ï¼‰

ã€è¾“å‡ºè¦æ±‚ã€‘ï¼š
- ç”¨ä¸­æ–‡ã€‚
- ä¸è¶…è¿‡ä¸¤å¥è¯ã€‚
- ç‚¹åä¸€ä¸ªå…·ä½“äº®ç‚¹æˆ–é—®é¢˜ï¼Œé¿å…â€œå¾ˆä¸é”™â€â€œå¯ä»¥æ›´å¥½â€è¿™ç±»ç©ºè¯ã€‚

è¯·ç»™å‡ºç‚¹è¯„ã€‚
"""
        return self.chat(prompt)

    def evaluate(
        self,
        transcript: List[QARecord],
        job: str,
        domain: str,
        company_profile: str,
    ) -> str:
        history = ""
        for rec in transcript:
            history += (
                f"[{rec.stage}] {rec.interviewer}ï¼š{rec.question}\n"
                f"å€™é€‰äººï¼š{rec.answer}\n\n"
            )

        prompt = f"""
ä½ æ˜¯ä¸€å {self.mbti} é¢è¯•å®˜ã€‚
ä½ çš„è¯„ä»·é€»è¾‘åŸºäºä½ çš„æé—®ä¸»é¢˜èŒƒå›´ï¼š
{TOPIC_SCOPE[self.mbti]}

è¿™æ¬¡é¢è¯•çš„é¢†åŸŸæ–¹å‘æ˜¯ï¼šã€Œ{domain}ã€ã€‚
å…¬å¸çš„ç»Ÿä¸€èƒŒæ™¯å¦‚ä¸‹ï¼š
----------------
{company_profile}
----------------

ä¸‹é¢æ˜¯å€™é€‰äººåœ¨åº”è˜ã€Œ{domain}ã€é¢†åŸŸçš„ã€Œ{job}ã€å²—ä½æ—¶çš„éƒ¨åˆ†é—®ç­”è®°å½•ï¼š
{history}

è¯·ç»™å‡ºâ€œä¸‰æ®µå¼æ­£å¼è¯„ä»·â€ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

1ï¼‰æ€»ä½“è¯„ä»·ï¼ˆ1-2 å¥è¯ï¼‰ï¼š
   - æ¦‚æ‹¬å€™é€‰äººçš„æ€§æ ¼ç‰¹ç‚¹ï¼ˆä»å›ç­”é£æ ¼æ¨æ–­ï¼‰
   - å¯¹ã€Œ{job}ã€åœ¨â€œè¿™å®¶å…¬å¸ï¼ˆ{domain}é¢†åŸŸï¼‰â€çš„åŒ¹é…åº¦åˆ¤æ–­
     ï¼ˆé€‚åˆ / åŸºæœ¬é€‚åˆ / æœ‰æ˜æ˜¾å·®è·ï¼Œå¹¶è¯´æ˜åŸå› ï¼‰

2ï¼‰ä¸‰ä¸ªä¸ã€Œ{job}ã€åœ¨è¯¥é¢†åŸŸç´§å¯†ç›¸å…³çš„ç»´åº¦è¯„åˆ†ï¼ˆ10 åˆ†åˆ¶ï¼‰ï¼š
   - ç»´åº¦åç§° + åˆ†æ•°ï¼ˆä¾‹å¦‚ï¼šè·¨å›¢é˜Ÿåä½œ 8/10ï¼‰
   - 1 å¥è§£é‡Šè¯´æ˜åˆ†æ•°åŸå› 
   - ç»´åº¦ç¤ºä¾‹ï¼šæ‰§è¡ŒåŠ›ã€é€»è¾‘æ€ç»´ã€ç»„ç»‡åè°ƒã€ç”¨æˆ·æ„è¯†ã€æŠ—å‹èƒ½åŠ›ç­‰ï¼ˆå¯è‡ªè¡Œé€‰æ‹©ï¼‰

3ï¼‰ä¸€æ¡æœ€å…³é”®çš„æ”¹è¿›å»ºè®®ï¼š
   - å»ºè®®å¿…é¡»å…·ä½“ã€å¯æ‰§è¡Œï¼Œä¾‹å¦‚ï¼š
     â€œå»ºè®®åœ¨å›ç­”æ—¶å¤šç»™ 1-2 ä¸ªçœŸå®é¡¹ç›®æ¡ˆä¾‹â€
     â€œå¯ä»¥è¡¥å……è¯´æ˜ä½ ä¼šç”¨å“ªäº›æŒ‡æ ‡æ¥åˆ¤æ–­æ–¹æ¡ˆå¥½åâ€
     â€œåœ¨æ¶‰åŠå†²çªåœºæ™¯æ—¶ï¼Œå¯ä»¥å¤šè¯´æ˜ä½ å¦‚ä½•å¹³è¡¡å…³ç³»å’Œç»“æœâ€ç­‰ã€‚

ã€è¾“å‡ºè¦æ±‚ã€‘ï¼š
- ç”¨ä¸­æ–‡ã€‚
- ç»“æ„æ¸…æ™°ï¼Œåˆ†æ®µè¾“å‡ºã€‚

è¯·æŒ‰ç…§ä¸Šè¿°ç»“æ„è¾“å‡ºè¯„ä»·ã€‚
"""
        return self.chat(prompt)


# ========== 6. é¢è¯•å®˜é˜µå®¹ ==========

def build_interviewers() -> List[Interviewer]:
    return [
        Interviewer(
            "ENTJ é¢è¯•å®˜", "ENTJ",
            "ä½ æ˜¯ ENTJ é¢è¯•å®˜ï¼Œå†³æ–­ã€æ‰§è¡Œã€ç»“æœå¯¼å‘ï¼Œè¯´è¯ç›´æ¥ä½†å…³æ³¨æ•ˆç‡ä¸å½±å“ã€‚"
        ),
        Interviewer(
            "INTP é¢è¯•å®˜", "INTP",
            "ä½ æ˜¯ INTP é¢è¯•å®˜ï¼Œé€»è¾‘å¼ºã€çˆ±æ¨ç†ã€ç»“æ„æ§ï¼Œå–œæ¬¢è¿½é—®â€œä¸ºä»€ä¹ˆâ€å’Œâ€œå¦‚æœâ€¦â€¦ä¼šæ€æ ·â€ã€‚"
        ),
        Interviewer(
            "ENFP é¢è¯•å®˜", "ENFP",
            "ä½ æ˜¯ ENFP é¢è¯•å®˜ï¼Œçƒ­æƒ…ã€å…³å¿ƒåŠ¨æœºã€æ³¨é‡æ•…äº‹ï¼Œæ›´åœ¨æ„å€™é€‰äººçš„ä»·å€¼è§‚å’Œæ½œåŠ›ã€‚"
        ),
        Interviewer(
            "ISTJ é¢è¯•å®˜", "ISTJ",
            "ä½ æ˜¯ ISTJ é¢è¯•å®˜ï¼Œä¸¥è°¨ã€åŠ¡å®ã€æ³¨é‡ç¨³å®šä¸æµç¨‹ï¼Œå…³æ³¨ç»†èŠ‚å’Œå¯æ‰§è¡Œæ€§ã€‚"
        ),
        Interviewer(
            "INFJ é¢è¯•å®˜", "INFJ",
            "ä½ æ˜¯ INFJ é¢è¯•å®˜ï¼Œæ´å¯Ÿæ·±ã€å–„äºçœ‹è§äººé™…å…³ç³»ä¸æƒ…ç»ªï¼Œé‡è§†å›¢é˜Ÿæ°›å›´ä¸é•¿æœŸå‘å±•ã€‚"
        ),
    ]


# ========== 7. é¢è¯•æµç¨‹ ==========

def run_interview():
    print("\n====== MBTI Multi-Agent Interviewï¼ˆèŒä¸šå®šåˆ¶ç‰ˆ / é¢†åŸŸæƒ…å¢ƒç‰ˆï¼‰======\n")

    # 0. é€‰æ‹©èŒä¸š
    job = input("ä½ æ­£åœ¨å‚åŠ ä»€ä¹ˆèŒä¸šçš„é¢è¯•ï¼Ÿä¾‹å¦‚ï¼šæ•°æ®åˆ†æå¸ˆã€äº§å“ç»ç†ã€UI è®¾è®¡å¸ˆï¼š\n> ").strip()
    if not job:
        job = "æ•°æ®åˆ†æå¸ˆ"
        print("æœªè¾“å…¥èŒä¸šï¼Œå°†é»˜è®¤ä½¿ç”¨ï¼šæ•°æ®åˆ†æå¸ˆ\n")
    else:
        print(f"\nå¥½çš„ï¼Œæ¥ä¸‹æ¥æ‰€æœ‰é¢è¯•é—®é¢˜éƒ½ä¼šå›´ç»•ï¼šã€Œ{job}ã€\n")

    # 0.1 é€‰æ‹©é¢†åŸŸæ–¹å‘
    domain = input(
        "ä½ æƒ³é¢è¯•çš„æ˜¯å“ªä¸€ç±»å…¬å¸çš„é¢†åŸŸæ–¹å‘ï¼Ÿ\n"
        "ä¾‹å¦‚ï¼šäº’è”ç½‘é‡‘èã€æ¶ˆè´¹ç”µå•†ã€æ¸¸æˆã€æ™ºèƒ½åˆ¶é€ ã€SaaS ä¼ä¸šæœåŠ¡ã€æ•™è‚²ç§‘æŠ€ç­‰ï¼š\n> "
    ).strip()
    if not domain:
        domain = "äº’è”ç½‘é‡‘è"
        print("æœªè¾“å…¥é¢†åŸŸæ–¹å‘ï¼Œå°†é»˜è®¤ä½¿ç”¨ï¼šäº’è”ç½‘é‡‘è\n")
    else:
        print(f"\nå¥½çš„ï¼Œè¿™æ¬¡æˆ‘ä»¬ä¼šå‡è®¾ä½ åœ¨ã€Œ{domain}ã€é¢†åŸŸçš„å…¬å¸é¢è¯•ã€Œ{job}ã€ã€‚\n")

    # 1. ç”Ÿæˆå…¬å¸èƒŒæ™¯ + è¡Œä¸šçŸ¥è¯†
    print("===== æ­£åœ¨ç”Ÿæˆè¯¥é¢†åŸŸå…¬å¸çš„èƒŒæ™¯ä¸è¡Œä¸šçŸ¥è¯†ï¼Œè¯·ç¨ç­‰â€¦â€¦ =====\n")
    company_profile = generate_company_profile(job, domain)
    print("===== æœ¬æ¬¡æ¨¡æ‹Ÿé¢è¯•çš„è™šæ„å…¬å¸èƒŒæ™¯ä¸è¡Œä¸šè¯´æ˜å¦‚ä¸‹ =====\n")
    print(company_profile)
    print("\nï¼ˆä½ å¯ä»¥å…ˆè¯»ä¸€éï¼Œç†è§£è¿™å®¶å…¬å¸æ‰€åœ¨çš„é¢†åŸŸã€ä¸šåŠ¡å’Œæ–‡åŒ–ï¼Œå†ç»§ç»­ä¸‹é¢çš„é¢è¯•ã€‚ï¼‰\n")

    interviewers = build_interviewers()
    transcript: List[QARecord] = []

    # 2. é¢è¯•å®˜é£æ ¼ä»‹ç»
    print("===== ç¯èŠ‚ä¸€ï¼šé¢è¯•å®˜é£æ ¼ä»‹ç» =====\n")
    for iv in interviewers:
        try:
            intro_text = iv.intro()
        except Exception as e:
            intro_text = f"(ä»‹ç»ç”Ÿæˆå¤±è´¥ï¼š{e})"
        print(f"- {iv.name}ï¼ˆ{iv.mbti}ï¼‰ï¼š{intro_text}")
    print()

    # 3. é€‰æ‹©é¢˜çƒ­èº«
    print("===== ç¯èŠ‚äºŒï¼šé€‰æ‹©é¢˜çƒ­èº«ï¼ˆæ¯ä½é¢è¯•å®˜ 1 é¢˜ï¼‰===== \n")
    for iv in interviewers:
        print(f"ã€{iv.name}ï¼ˆ{iv.mbti}ï¼‰ã€‘çš„é€‰æ‹©é¢˜ï¼š")
        q_mc = iv.ask_mc_question(job, domain, company_profile)
        # ç®€å•æ£€æŸ¥æ˜¯å¦æœ‰ A/B/C/D
        if not all(tag in q_mc for tag in ["A.", "B.", "C.", "D."]):
            print("ï¼ˆâš  æç¤ºï¼šæœ¬é¢˜è¾“å‡ºæ ¼å¼å¯èƒ½ä¸å®Œæ•´ï¼Œè¯·ç•™æ„é€‰é¡¹æ˜¯å¦é½å…¨ï¼‰")
        print(q_mc)
        ans_mc = input("\nä½ çš„é€‰æ‹©ï¼ˆå¯è¾“å…¥ A/B/C/Dï¼Œæˆ–è¾“å…¥ä½ è‡ªå·±çš„å®Œæ•´æƒ³æ³•ï¼‰ï¼š\n> ")
        transcript.append(QARecord("mc", iv.name, q_mc, ans_mc))
        print("\n------------------------\n")

    # 4. å¿«é€Ÿå¼€æ”¾å¼æé—®
    print("===== ç¯èŠ‚ä¸‰ï¼šå¿«é€Ÿå¼€æ”¾å¼æé—® =====\n")
    for iv in interviewers:
        q = iv.ask_rapid(job, domain, company_profile)
        print(f"{iv.name}ï¼ˆ{iv.mbti}ï¼‰ï¼š{q}\n")
        ans = input("ä½ çš„å›ç­”ï¼š\n> ")
        transcript.append(QARecord("rapid", iv.name, q, ans))
        print("\n------------------------\n")

    # 5. æ·±åº¦è¿½é—®ï¼ˆåŸºäºç¬¬ä¸€æ¡å›ç­”ï¼‰
    print("===== ç¯èŠ‚å››ï¼šæ·±åº¦è¿½é—® =====\n")
    if transcript:
        base_ans = transcript[0].answer
    else:
        base_ans = ""

    entj = interviewers[0]
    infj = interviewers[-1]

    # ENTJ æ·±åº¦è¿½é—®
    q1 = entj.ask_follow_up(base_ans, job, domain, company_profile)
    print(f"{entj.name}ï¼ˆ{entj.mbti}ï¼‰ï¼š{q1}\n")
    ans1 = input("ä½ çš„å›ç­”ï¼š\n> ")
    transcript.append(QARecord("follow_up", entj.name, q1, ans1))
    print("\n------------------------\n")

    # INFJ æ·±åº¦è¿½é—®
    q2 = infj.ask_follow_up(base_ans, job, domain, company_profile)
    print(f"{infj.name}ï¼ˆ{infj.mbti}ï¼‰ï¼š{q2}\n")
    ans2 = input("ä½ çš„å›ç­”ï¼š\n> ")
    transcript.append(QARecord("follow_up", infj.name, q2, ans2))
    print("\n------------------------\n")

    # 6. æƒ…å¢ƒé¢˜ + å³æ—¶ç‚¹è¯„
    print("===== ç¯èŠ‚äº”ï¼šæƒ…å¢ƒé¢˜ï¼ˆENTJ å‡ºé¢˜ï¼Œå…¶ä»–äººç‚¹è¯„ï¼‰===== \n")
    scenario_q = entj.ask_scenario(job, domain, company_profile)
    print(f"{entj.name}ï¼ˆ{entj.mbti}ï¼‰ï¼š{scenario_q}\n")
    s_ans = input("ä½ çš„å›ç­”ï¼š\n> ")
    transcript.append(QARecord("scenario", entj.name, scenario_q, s_ans))

    print("\nâ€”â€” å…¶ä»–é¢è¯•å®˜å³æ—¶ç‚¹è¯„ â€”â€”\n")
    for iv in interviewers:
        if iv is entj:
            continue
        try:
            comment_text = iv.comment(scenario_q, s_ans, job, domain, company_profile)
        except Exception as e:
            comment_text = f"(ç‚¹è¯„ç”Ÿæˆå¤±è´¥ï¼š{e})"
        print(f"{iv.name}ï¼ˆ{iv.mbti}ï¼‰ï¼š{comment_text}\n")

    # 7. ç»¼åˆè¯„ä»·
    print("\n===== ç¯èŠ‚å…­ï¼šç»¼åˆè¯„ä»·ï¼ˆæ¯ä½é¢è¯•å®˜ç»™æ­£å¼åé¦ˆï¼‰ =====\n")
    for iv in interviewers:
        print(f"ã€{iv.name}ï¼ˆ{iv.mbti}ï¼‰çš„èŒä¸šå‘è¯„ä»·ã€‘\n")
        try:
            eval_text = iv.evaluate(transcript, job, domain, company_profile)
        except Exception as e:
            eval_text = f"(è¯„ä»·ç”Ÿæˆå¤±è´¥ï¼š{e})"
        print(eval_text, "\n")
        print("------------------------------------------------\n")

    # 8. è‡ªæˆ‘æ€»ç»“
    print("\n===== æœ€ç»ˆæ€»ç»“ï¼ˆç»™ä½ è‡ªå·±çš„åæ€æ—¶é—´ï¼‰=====\n")
    print(f"ä½ åœ¨ã€Œ{domain}ã€é¢†åŸŸçš„ã€Œ{job}ã€å²—ä½æ•´ä½“è¡¨ç°ï¼Œå¯ä»¥æ€è€ƒï¼š")
    print("1ï¼‰åœ¨å“ªäº›ç¯èŠ‚ï¼Œä½ è§‰å¾—è‡ªå·±è¡¨è¾¾å¾—æœ€å¥½ï¼Ÿ")
    print("2ï¼‰å“ªä½é¢è¯•å®˜çš„è¯„ä»·æœ€æˆ³ä¸­ä½ ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ")
    print("3ï¼‰å¦‚æœä»¥åçœŸçš„å»é¢è¯•ç±»ä¼¼å…¬å¸ï¼Œä½ ä¼šåœ¨å“ªä¸‰ä¸ªæ–¹é¢ä¼˜åŒ–è‡ªå·±çš„è¡¨è¾¾ï¼Ÿ\n")
    print("æœ¬æ¬¡æ¨¡æ‹Ÿé¢è¯•ç»“æŸ ğŸ‰ æ„Ÿè°¢å‚ä¸ï¼\n")


if __name__ == "__main__":
    run_interview()
